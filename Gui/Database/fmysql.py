import mysql.connector
from . import conn as cn
# from .models import models
# import conn as cn
from . import models
import time
import random
import json

class conect_mysql(object):

  def __init__(self,conn_par):
    self.conn = cn.conn(**conn_par)
    # lei_dir = dir(models)
    self.lei_dir = list(filter(lambda x:not '_'in x, dir(models)))
    # self.create_table()
    # try:
    #   self.insert_nar('account',[self.id,datetime.datetime.now().replace(microsecond=0)])
    # except mysql.connector.Error as e:
    #   if e.errno != 1062:
    #         print(e.errno)

  def __connet(self):      
    try: 
      conn_mysql = None
      conn_mysql = mysql.connector.connect(host=self.conn.host,user=self.conn.user,passwd=self.conn.password,database = self.conn.database)
      cursor = conn_mysql.cursor()
    except mysql.connector.Error as e:
      if e.errno == 1049 and 'Unknown database'in e.msg:
        self.create_database()
        self.create_table()
      conn_mysql = mysql.connector.connect(host=self.conn.host,user=self.conn.user,passwd=self.conn.password,database = self.conn.database)
      
    return conn_mysql
      
  def _(self,tab):
      return '{}_{}'.format(self.conn.prefix,tab)
  
  def execute_sql(self,sql,val = ''):
    
    conn = self.__connet()
    
    cursor = conn.cursor()
    
    if val:
      cursor.execute(sql,val)
    else:
      try:
        cursor.execute(sql)
      except mysql.connector.errors.ProgrammingError as e:
        if e.errno == 1146:
          self.create_table()
          conn = self.__connet()
          cursor = conn.cursor()
          if val:
            cursor.execute(sql,val)
          else:
            cursor.execute(sql)

    if 'SELECT' in sql:
      result = cursor.fetchall()
    else:
      conn.commit()
      result = ''
    
    if cursor:
      cursor.close()
    if conn:
      conn.close()
    
    return result
    
  def create_database(self):
    sql = f"create database {self.conn.database}"
    conn_mysql = mysql.connector.connect(host=self.conn.host,user=self.conn.user,passwd=self.conn.password)
    cursor = conn_mysql.cursor()
    cursor.execute(sql)
    conn_mysql.commit()
    if cursor:
      cursor.close()
    if conn_mysql:
      conn_mysql.close()
  
  def create_table(self):
    for index in self.lei_dir:
        app = getattr(models,index)
        S = ','.join(i for i in app.status)
        sql = "CREATE TABLE {} ({})".format(self._(app.__name__),S)
        self.execute_sql(sql)

  def insert(self,tables,ins_data):
      app = getattr(models,tables)
      Key = ','.join(app.keylist)
      S = ','.join('%s' for i in range(len(ins_data)))
      val = tuple(ins_data)
      sql = f"insert into {self._(tables)} ({Key}) values ({S})"
      try:
        self.execute_sql(sql,val)
      except mysql.connector.Error as e:
        if e.errno != 1062:
            print(e.errno)
      
  def select(self,tables,start = 0,mun = 1,**kwargs):
      where = ''
      def select_data(**kwargs):
        conditions = []
        for k, v in kwargs.items():
            if k == 'timestamp':
              v1,v2= v.split('_')
              conditions.append(f"{k}  {v1} '{v2}'")
            else:
              conditions.append(f"{k} = '{v}'")
        return ' AND '.join(conditions)
      
      select_tj = select_data(**kwargs)
      
      if select_tj:
        where = f'WHERE {select_tj}'
      app = getattr(models,tables)
      idlist = ['id']+app.keylist
      Key = ','.join(idlist)
      sql = f"SELECT {Key} FROM {self._(tables)} {where} ORDER BY id DESC LIMIT {start},{mun}"
      result = self.execute_sql(sql)
      result = [{idlist[i]: item[i] for i in range(len(item))} for item in result]
      return result

  def update(self,tables,re_data, **kwargs):
    updates = ','.join([f'{k}=%s'for k in re_data.keys()])
    select_data = ' and '.join([f'{k[0]} = \'{k[1]}\''for k in kwargs.items()])
    sql = f"UPDATE {self._(tables)} SET {updates} WHERE {select_data}" 
    val = tuple(list(re_data.values()))
    self.execute_sql(sql,val)
    
  def re_del(self,tables,id):
    sql = f"DELETE FROM {self._(tables)} WHERE id = {id}"
    self.execute_sql(sql)
    
if __name__ == '__main__':
  database = {'id':'','host':'','user':'','password':'','database':'','prefix':''}
  user = ''
  re = conect_mysql(database)
  # re.re_del('account',7)
  
  re = re.select('account', user = user)
  print(re)
  
  #   error = {"order_id": "", "error_code": "5100{}".format(random.randint(0,3)), "error_essage": "Order price is not within the price limit (max buy price: 1,138.17 min sell price: 1,093.51)"}
  #   qlink = {"shape": "+X&-2X", "start": 1080.04, "node": 1197.8319999999999, "step": 1.0209188302015297, "after": 3, "current": 3, "kdj": 100.0, "moved": 1, "Now": {"start": ["1669107600000", 1080.04], "end": ["1669168800000", 1161.92], "rise": [81.88000000000011, 0.07581200696270529], "state": "long", "prices": [1080.04, 1134.1, 1116.25, 1161.92], "trend": [6, 10, 4, 5], "chg": [0.05005370171475132, -0.01573935279075911, 0.040913773796192654]}, "boll": {"up": ["+1.5"], "down": [], "up+": [2], "down+": [], "ud": 1.0634839276561472, "span": 1.1013083160168016}, "place": []}
  #   orders = {"timestamp": "1669079102", "instrument_id": "ETH-USD-SWAP", "plan": [[1026.43, 2, 2], [1039.53, 2, 2], [1043.65, 2, 2], [1047.78, 2, 2], [1051.93, 2, 2], [1054.26, 2, 2], [1056.59, 2, 2], [1058.93, 2, 2], [1061.28, 2, 2], [1063.63, 2, 2], [1065.2, 2, 2], [1066.78, 2, 2], [1068.35, 2, 2], [1069.93, 2, 2], [1071.52, 2, 2], [1073.1, 2, 2], [1074.68, 2, 2], [1075.84, 2, 2], [1076.99, 1, 2], [1078.15, 1, 2], [1079.31, 1, 2], [1080.46, 1, 2], [1081.62, 1, 2], [1082.78, 1, 2], [1083.95, 1, 2], [1085.11, 1, 2], [1086.0, 1, 2], [1086.89, 1, 2], [1087.78, 1, 2], [1088.67, 1, 2], [1089.57, 1, 2], [1090.46, 1, 2], [1091.35, 1, 2], [1092.25, 1, 2], [1093.15, 1, 2], [1094.04, 1, 2], [1094.94, 1, 2], [1095.65, 1, 2], [1096.36, 1, 2], [1097.07, 1, 2], [1097.78, 1, 2], [1098.49, 1, 2], [1099.2, 1, 2], [1099.92, 1, 2], [1100.63, 1, 2], [1101.34, 1, 2], [1102.06, 1, 2], [1102.77, 1, 2], [1103.48, 1, 2], [1104.2, 1, 2], [1104.75, 1, 2], [1105.3, 1, 2], [1105.85, 1, 2], [1106.4, 1, 2], [1106.95, 1, 2], [1107.51, 1, 2], [1108.06, 1, 2], [1108.61, 1, 2], [1109.16, 1, 2], [1109.72, 1, 2], [1110.27, 1, 2], [1110.82, 1, 2], [1111.38, 1, 2], [1111.93, 1, 2], [1112.49, 1, 2], [1112.95, 1, 2], [1113.41, 1, 2], [1113.87, 1, 2], [1114.33, 1, 2], [1114.8, 1, 2], [1115.26, 1, 2], [1115.72, 1, 2], [1116.18, 1, 2], [1116.65, 1, 2], [1117.11, 1, 2], [1117.57, 1, 2], [1118.03, 1, 2], [1118.5, 1, 2], [1118.96, 1, 2], [1119.43, 1, 2], [1119.89, 1, 2], [1120.35, 1, 2], [1120.74, 1, 2], [1121.12, 1, 2], [1121.5, 1, 2], [1121.88, 1, 2], [1122.26, 1, 2], [1122.64, 1, 2], [1123.02, 1, 2], [1123.41, 1, 2], [1123.79, 1, 2], [1124.17, 1, 2], [1124.55, 1, 2], [1124.94, 1, 2], [1125.32, 1, 2], [1125.7, 1, 2], [1126.08, 1, 2], [1126.47, 1, 2], [1126.85, 1, 2], [1127.23, 1, 2], [1127.62, 1, 2], [1127.95, 1, 2], [1128.28, 1, 2], [1128.62, 1, 2], [1128.95, 1, 2], [1129.29, 1, 2], [1129.62, 1, 2], [1129.95, 1, 2], [1130.29, 1, 2], [1130.62, 1, 2], [1130.96, 1, 2], [1131.29, 1, 2], [1131.62, 1, 2], [1131.96, 1, 2], [1132.29, 1, 2], [1132.63, 1, 2], [1132.96, 1, 2], [1133.3, 1, 2], [1133.63, 1, 2], [1133.97, 1, 2], [1134.3, 1, 2], [1134.64, 1, 2], [1134.92, 1, 2], [1135.21, 1, 2], [1135.49, 1, 2], [1135.78, 1, 2], [1136.07, 1, 2], [1136.35, 1, 2], [1136.64, 1, 2], [1136.92, 1, 2], [1137.21, 1, 2], [1137.5, 1, 2], [1137.78, 1, 2], [1138.07, 1, 2], [1138.35, 1, 2], [1138.64, 1, 2], [1138.93, 1, 2], [1139.21, 1, 2], [1139.5, 1, 2], [1139.79, 1, 2], [1140.07, 1, 2], [1140.36, 1, 2], [1140.65, 1, 2], [1140.93, 1, 2]], "orders": {"515090322695798787": ["1105.96", "2", "4", "2"], "515090324600012828": ["1105.96", "2", "4", "2"], "515090326873325569": ["1105.96", "2", "4", "2"], "515090328983060482": ["1105.96", "2", "4", "2"], "515090330841137157": ["1106.06", "2", "4", "2"], "515090332988620815": ["1106.37", "2", "4", "2"], "515090336553779203": ["1106.48", "2", "4", "2"], "515090340643225603": ["1106.38", "2", "4", "2"], "515090344824946689": ["1106.13", "2", "4", "2"], "515090348960530486": ["1105.97", "2", "4", "2"], "515090353012228097": ["1106", "2", "4", "2"], "515090357001011211": ["1106.07", "2", "4", "2"], "515090361019154439": ["1106.07", "2", "4", "2"], "515090365330898948": ["1106.07", "2", "4", "2"], "515090369349042176": ["1105.99", "2", "4", "2"], "515090373404934149": ["1105.75", "2", "4", "2"], "515090377561489409": ["1105.86", "2", "4", "2"], "515090381936148481": ["1105.73", "2", "4", "2"], "515090386025594887": ["1105.82", "1", "4", "2"], "515090390010183681": ["1105.82", "1", "4", "2"], "515090394049298432": ["1105.82", "1", "4", "2"], "515090398302322695": ["1105.82", "1", "4", "2"], "515090402211414016": ["1105.89", "1", "4", "2"], "515090406468632584": ["1105.83", "1", "4", "2"], "515090410537107458": ["1105.8", "1", "4", "2"], "515090413666058254": ["1105.57", "1", "4", "2"], "515090416782426113": ["1105.66", "1", "4", "2"], "515090419890405393": ["1105.66", "1", "4", "2"], "515090423052910597": ["1105.66", "1", "4", "2"], "515090426437713939": ["1105.58", "1", "4", "2"], "515090429616996360": ["1105.58", "1", "4", "2"], "515090432712392716": ["1105.58", "1", "4", "2"], "515090436076224533": ["1105.57", "1", "4", "2"], "515090439230341146": ["1105.68", "1", "4", "2"], "515090442204102657": ["1105.57", "1", "4", "2"], "515090445349830656": ["1105.56", "1", "4", "2"], "515090448327786504": ["1105.54", "1", "4", "2"], "515090451599343631": ["1105.56", "1", "4", "2"], "515090456586371072": ["1105.55", "1", "4", "2"], "515090459828568067": ["1105.65", "1", "4", "2"], "515090462915575824": ["1105.58", "1", "4", "2"], "515090466048720906": ["1105.58", "1", "4", "2"], "515090469123145728": ["1105.58", "1", "4", "2"], "515090472231125001": ["1105.55", "1", "4", "2"], "515090475339104260": ["1105.55", "1", "4", "2"], "515090478593884168": ["1105.54", "1", "4", "2"], "515090481676697610": ["1105.53", "1", "4", "2"], "515090484650459137": ["1105.54", "1", "4", "2"], "515090487758438402": ["1105.55", "1", "4", "2"], "515090490811891715": ["1105.56", "1", "4", "2"], "515090493945036801": ["1105.56", "1", "4", "2"], "515090496973324288": ["1105.54", "1", "4", "2"], "515090500156801025": ["1105.85", "1", "4", "2"], "515090503646461954": ["1106.4", "1", "4", "2"], "515090506905436160": ["1106.95", "1", "4", "2"], "515090510206353416": ["1107.51", "1", "4", "2"], "515090513389830151": ["1108.06", "1", "4", "2"], "515092403586482179": ["1108.61", "1", "4", "2"], "515092692397867021": ["1109.16", "1", "4", "2"], "515093570928394294": ["1109.72", "1", "4", "2"], "515093573847629852": ["1110.27", "1", "4", "2"], "515093577089826817": ["1110.82", "1", "4", "2"], "515093580176834576": ["1111.38", "1", "4", "2"], "515093583138013191": ["1111.93", "1", "4", "2"], "515119045516083203": ["1112.49", "1", "4", "2"], "515121010207768576": ["1112.95", "1", "4", "2"], "515273273177948214": ["1113.41", "1", "4", "2"], "515273276478865468": ["1113.87", "1", "4", "2"], "515273285970575360": ["1114.33", "1", "4", "2"], "515273288885616703": ["1114.8", "1", "4", "2"], "515273378652110865": ["1115.26", "1", "4", "2"], "515273381621678106": ["1115.72", "1", "4", "2"], "515273384788377620": ["1116.18", "1", "4", "2"], "515273387749556224": ["1116.65", "1", "4", "2"], "515273390761066512": ["1117.11", "1", "4", "2"], "515273412135239683": ["1117.57", "1", "4", "2"], "515273414983172244": ["1118.03", "1", "4", "2"], "515273417998876698": ["1118.5", "1", "4", "2"], "515273420943278093": ["1118.96", "1", "4", "2"], "515274058544594996": ["1119.43", "1", "4", "2"], "515274159614738432": ["1119.89", "1", "4", "2"], "515274162735300640": ["1120.35", "1", "4", "2"], "515274184172388365": ["1120.74", "1", "4", "2"], "515274187037098029": ["1121.12", "1", "4", "2"], "515278532432510983": ["1121.5", "1", "4", "2"], "515278534445776896": ["1121.88", "1", "4", "2"], "515278538069655628": ["1122.26", "1", "4", "2"], "515278541408321542": ["1122.64", "1", "4", "2"], "515278544281419779": ["1123.02", "1", "4", "2"], "515278547175489580": ["1123.41", "1", "4", "2"], "515283165590732846": ["1123.79", "1", "4", "2"], "515283167545278535": ["1124.17", "1", "4", "2"], "515283175648673793": ["1124.55", "1", "4", "2"], "515283178525966366": ["1124.94", "1", "4", "2"], "515283181935935512": ["1125.32", "1", "4", "2"], "515283184905502724": ["1125.7", "1", "4", "2"], "515283187933790208": ["1126.08", "1", "4", "2"], "515283288001495044": ["1126.47", "1", "4", "2"], "515283293227597870": ["1126.85", "1", "4", "2"], "515283296163610672": ["1127.23", "1", "4", "2"], "515283299535831040": ["1127.62", "1", "4", "2"], "515283302467649548": ["1127.95", "1", "4", "2"], "515283305391079455": ["1128.28", "1", "4", "2"], "515283308318703624": ["1128.62", "1", "4", "2"], "515283605581611022": ["1128.95", "1", "4", "2"], "515283608383406094": ["1129.29", "1", "4", "2"], "515283611428470791": ["1129.62", "1", "4", "2"], "515283614335123456": ["1129.95", "1", "4", "2"], "515283631116533765": ["1130.29", "1", "4", "2"], "515283968703479811": ["1130.62", "1", "4", "2"], "515284341702934536": ["1130.96", "1", "4", "2"], "515284344634753030": ["1131.29", "1", "4", "2"], "515284347885338640": ["1131.62", "1", "4", "2"], "515284350892654626": ["1131.96", "1", "4", "2"], "515284353790918663": ["1132.29", "1", "4", "2"], "515284356806623251": ["1132.63", "1", "4", "2"], "515284367313354789": ["1132.96", "1", "4", "2"], "515284370282921987": ["1133.3", "1", "4", "2"], "515284374032629778": ["1133.63", "1", "4", "2"], "515284377119637505": ["1133.97", "1", "4", "2"], "515284380462497809": ["1134.3", "1", "4", "2"], "515284383557894170": ["1134.64", "1", "4", "2"], "515284386569404422": ["1134.92", "1", "4", "2"], "515284389421531153": ["1135.21", "1", "4", "2"], "515284392311406592": ["1135.49", "1", "4", "2"], "515284395205476375": ["1135.78", "1", "4", "2"], "515285380833361936": ["1136.07", "1", "4", "2"], "515285386113990717": ["1136.35", "1", "4", "2"], "515285389381353515": ["1136.64", "1", "4", "2"], "515285392548053010": ["1136.92", "1", "4", "2"], "515285397824487460": ["1137.21", "1", "4", "2"], "515285400827609097": ["1137.5", "1", "4", "2"], "515285403864285227": ["1137.78", "1", "4", "2"], "515285406980653063": ["1138.07", "1", "4", "2"], "515287239006502912": ["1138.35", "1", "4", "2"], "515287241963487283": ["1138.64", "1", "4", "2"], "515287245016940565": ["1138.93", "1", "4", "2"], "515287248070393857": ["1139.21", "1", "4", "2"], "515287251174178823": ["1139.5", "1", "4", "2"], "515287306434134034": ["1139.79", "1", "4", "2"], "515287309307232268": ["1140.07", "1", "4", "2"], "515287312306159628": ["1140.36", "1", "4", "2"], "515287315074400265": ["1140.65", "1", "4", "2"], "515287318081716259": ["1140.93", "1", "4", "2"], "515287320904482817": ["1140.93", "1", "4", "2"], "515287323983101953": ["1140.93", "1", "4", "2"], "515287358732910643": ["1140.93", "1", "4", "2"], "515287361685700632": ["1140.93", "1", "4", "2"], "515287364676239362": ["1140.99", "1", "4", "2"], "515287367603863595": ["1141.76", "1", "4", "2"], "515287370648928271": ["1140.93", "1", "4", "2"], "515287373576552460": ["1140.93", "1", "4", "2"], "515287376634200064": ["1140.93", "1", "4", "2"], "515287379691847705": ["1140.93", "1", "4", "2"], "515287382560751629": ["1140.93", "1", "4", "2"], "515287385660342352": ["1140.93", "1", "4", "2"], "515287389825286204": ["1140.93", "1", "4", "2"], "515287392820019212": ["1140.93", "1", "4", "2"], "515313834362552345": ["1140.93", "1", "4", "2"], "515313836514230272": ["1141.12", "1", "4", "2"], "515313840071000102": ["1141.05", "1", "4", "2"], "515313843195756545": ["1140.93", "1", "4", "2"], "515313847134208006": ["1140.93", "1", "4", "2"], "515313851081048066": ["1140.93", "1", "4", "2"], "515313854059003907": ["1140.93", "1", "4", "2"], "515313857590607945": ["1140.93", "1", "4", "2"]}, "cover": {"515277507369779208": ["1114.0537969767750661", "79", "2", "2"], "515279208772419587": ["1115.25", "6", "2", "2"]}, "index": 143, "total": 144, "type": 2, "statis": [0, 0, 0, 0], "strategy": "alone", "market": "8", "task_shape": "-X&+X", "task_gps": "1668517200000&15", "risk": [0.009, 0.015], "task_par": 1, "stage": {"i": 1, "mun": [[1133.5139550000001, 5, 4]], "price": 1133.5139550000001, "add": []}, "chase": {"i": 0, "mun": [[1084.05, 1, 2], [1087.2190000893975, 1, 2], [1087.936143840515, 1, 2], [1088.6532875916323, 1, 2], [1089.360740210978, 1, 2], [1089.6514741641338, 1, 2], [1089.9422081172895, 1, 2], [1090.2232509386733, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1090.513984891829, 1, 2], [1092.7138718040408, 1, 2], [1093.1984283926336, 1, 2], [1093.3244131056679, 1, 2], [1093.4600889504738, 1, 2], [1093.5957647952798, 1, 2], [1093.6636027176828, 1, 2], [1093.7314406400858, 1, 2], [1093.799278562489, 1, 2], [1093.8671164848918, 1, 2], [1093.9252632755229, 1, 2], [1093.9737189343823, 1, 2], [1094.0124834614699, 1, 2], [1094.0512479885572, 1, 2], [1094.0900125156447, 1, 2], [1094.128777042732, 1, 2], [1094.1675415698194, 1, 2], [1094.2159972286786, 1, 2], [1094.2353794922224, 1, 2], [1094.264452887538, 1, 2], [1094.2935262828537, 1, 2], [1094.3129085463975, 1, 2], [1094.341981941713, 1, 2], [1094.3710553370286, 1, 2], [1094.390437600572, 1, 2], [1094.4195109958878, 1, 2], [1094.4485843912032, 1, 2], [1094.467966654747, 1, 2], [1094.4873489182905, 1, 2], [1094.4970400500627, 1, 2], [1094.5164223136064, 1, 2], [1094.5358045771502, 1, 2], [1094.5551868406938, 1, 2], [1094.5745691042375, 1, 2], [1094.5939513677813, 1, 2], [1094.6133336313248, 1, 2], [1094.6327158948686, 1, 2], [1094.6424070266405, 1, 2], [1094.661789290184, 1, 2], [1094.671480421956, 1, 2], [1094.6811715537278, 1, 2], [1094.7005538172716, 1, 2], [1094.7102449490435, 1, 2], [1094.7199360808152, 1, 2], [1094.7393183443592, 1, 2], [1094.749009476131, 1, 2], [1094.758700607903, 1, 2], [1094.7780828714465, 1, 2], [1094.7877740032184, 1, 2], [1094.7974651349903, 1, 2], [1094.816847398534, 1, 2], [1094.8265385303057, 1, 2], [1094.8362296620776, 1, 2], [1094.8362296620776, 1, 2], [1094.8459207938495, 1, 2], [1094.8556119256214, 1, 2], [1094.8653030573932, 1, 2], [1094.8749941891651, 1, 2], [1094.8846853209368, 1, 2], [1094.8943764527087, 1, 2], [1094.9040675844806, 1, 2], [1094.9137587162525, 1, 2], [1094.9234498480243, 1, 2], [1094.9331409797962, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2], [1094.942832111568, 1, 2]], "price": 1084.05, "add": []}, "Mobile_revenue": {}, "insert": 2, "warning": "ture", "discard": "ture"}

